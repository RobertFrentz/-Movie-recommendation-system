@page "/movies"
@inject HttpClient Http
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage


<div class="row d-flex flex-wrap-reverse">

    <div class="container col-xl-10">

        <h1 class="font-weight-light text-center text-lg-left mt-4 mb-0">@TitleToDisplay</h1>
        <hr class="mt-2 mb-5">

        @if (moviesToDisplay == null)
        {
            if (searchResultIsEmpty == false)
            {
                <p><em>Loading Movies Data...</em></p>
                <img class="mx-auto d-block" src="images/loading.gif" alt="Image">
            }
        }
        else
        {
            <span>TEST  currentPage:@currentPage</span>

            <div class="row">
                @foreach (var item in moviesToDisplay)
                {
                    <div class="container border shadow text-center mb-4" style="width: 300px; min-height: 450px; ">
                        <a class="text-decoration-none" href="movies/@item.Id">
                            <img src="@item.PosterUrl" alt="@item.Title Poster" title="@item.Title" style="width:100%; height:400px">
                            <p class="mt-2">@item.Title</p>
                        </a>
                    </div>

                }
            </div>
        }

        <ul class="pagination justify-content-end">
            <li class="page-item"><button class="page-link" @onclick='(() => SetPreviousPageMovies())'>Previous</button></li>
            @if (numberOfPages < 10)
            {
                @for (int pageN = 1; pageN <= numberOfPages; pageN++)
                {
                    var localCopy = pageN;
                    if (pageN == currentPage)
                    {
                        <li class="page-item active"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                    }
                    else
                    {
                        <li class="page-item"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                    }
                }
            }
            else
            {
                @for (int pageN = 1; pageN <= 3; pageN++)
                {
                    var localCopy = pageN;
                    if (pageN == currentPage)
                    {
                        <li class="page-item active"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                    }
                    else
                    {
                        <li class="page-item"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                    }
                }
                <li class="page-item"><button class="page-link">...</button></li>
                if ((currentPage < 4) || (currentPage > (numberOfPages - 3)))
                {
                    var middleIndex = numberOfPages / 2;
                    @for (int pageN = middleIndex - 1; pageN <= middleIndex + 1; pageN++)
                    {
                        var localCopy = pageN;
                        if (pageN == currentPage)
                        {
                            <li class="page-item active"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                        }
                        else
                        {
                            <li class="page-item"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                        }
                    }
                }
                else
                {
                    @for (int pageN = currentPage - 1; pageN <= currentPage + 1; pageN++)
                    {
                        var localCopy = pageN;
                        if (pageN == currentPage)
                        {
                            <li class="page-item active"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                        }
                        else
                        {
                            <li class="page-item"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                        }
                    }
                }
                <li class="page-item"><button class="page-link">...</button></li>
                @for (int pageN = numberOfPages - 2; pageN <= numberOfPages; pageN++)
                {
                    var localCopy = pageN;
                    if (pageN == currentPage)
                    {
                        <li class="page-item active"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                    }
                    else
                    {
                        <li class="page-item"><button class="page-link" @onclick='(() => GetMoviesOnGivenPage(localCopy))'>@localCopy</button></li>
                    }
                }

            }

            <li class="page-item"><button class="page-link" @onclick='(() => SetNextPageMovies())'>Next</button></li>
        </ul>

    </div>

    <div class="container col-xl-2">
        <div class="container-fluid mb-4">
            <h4 class="font-weight-light text-center mb-3">Search for a movie:</h4>
            <input type="text" class="w-100 mb-2" @bind="searchMovieName" />
            <button type="button" class="btn btn-outline-dark btn-block" @onclick="SearchMoviesByName">Search</button>
        </div>

        <div class="container-fluid">
            <h4 class="font-weight-light text-center mb-3">Or find by category:</h4>
            <div class="btn-group-vertical w-100">
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Action"))'>Action</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Adventure"))'>Adventure</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Animation"))'>Animation</button>
                @*<button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Biography"))'>Biography</button>*@
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Comedy"))'>Comedy</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Crime"))'>Crime</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Documentary"))'>Documentary</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Drama"))'>Drama</button>
                @*<button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Family"))'>Family</button>*@
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Fantasy"))'>Fantasy</button>
                @*<button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Film Noir"))'>Film Noir</button>*@
                @*<button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("History"))'>History</button>*@
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Horror"))'>Horror</button>
                @*<button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Music"))'>Music</button>*@
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Mystery"))'>Mystery</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Romance"))'>Romance</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Sci-Fi"))'>Sci-Fi</button>
                @*<button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Sport"))'>Sport</button>*@
                @*<button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Superhero"))'>Superhero</button>*@
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Thriller"))'>Thriller</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("War"))'>War</button>
                <button type="button" class="btn btn-outline-dark btn-block" @onclick='(() => SearchMoviesByCategory("Western"))'>Western</button>
            </div>
        </div>
    </div>

</div>


@code {
    private string TitleToDisplay = "Recommended for You";
    private List<MovieDetails> moviesToDisplay;
    private List<int> receivedMoviesIds;
    private int numberOfPages, currentPage;
    private string searchMovieName;
    private bool searchResultIsEmpty;
    private int moviesPerPage = 12;

    private string apiUrl = "http://localhost:5000/api/Movies/HomeMoviesData";
    private string searchMoviesByCategoryApiUrl = "http://localhost:5020/api/v1/search/category?category=";
    private string searchMoviesByKeywordApiUrl = "http://localhost:5020/api/v1/search/keyword?keyword=";

    protected override async Task OnInitializedAsync()
    {
        // aparent recomandarile nu merg inca
        //if (await IsUserLoggedIn())
        if (1 != 1)
        {
            string apiEndpoint = "http://localhost:5020/api/v1/search/ratings";
            string token = await sessionStorage.GetItemAsync<string>("jwt");

            var request = new HttpRequestMessage(HttpMethod.Get, apiEndpoint);
            request.Headers.Add("Authentification_Token", token);
            using var httpResponse = await Http.SendAsync(request);
            receivedMoviesIds = await httpResponse.Content.ReadFromJsonAsync<List<int>>();
        }
        else
        {
            receivedMoviesIds = await Http.GetFromJsonAsync<List<int>>(apiUrl);

        }
        numberOfPages = receivedMoviesIds.Count / moviesPerPage + 1;
        currentPage = 1;
        await GetMoviesOnGivenPage(currentPage);
    }

    private async Task SetNextPageMovies()
    {
        if ((currentPage + 1) <= numberOfPages)
        {
            currentPage++;
            await GetMoviesOnGivenPage(currentPage);
        }

    }

    private async Task SetPreviousPageMovies()
    {
        if ((currentPage - 1) >= 1)
        {
            currentPage--;
            await GetMoviesOnGivenPage(currentPage);
        }
    }

    private async Task GetMoviesOnGivenPage(int pageN)
    {
        int startPos, amount;
        moviesToDisplay = null;
        startPos = (pageN - 1) * moviesPerPage;
        amount = (pageN * moviesPerPage) < receivedMoviesIds.Count ? moviesPerPage : (receivedMoviesIds.Count - startPos);
        currentPage = pageN;
        Console.WriteLine($"GetMoviesOnGivenPage: pageN:{pageN} startPos:{startPos} amount:{amount} receivedMoviesIds.Count:{receivedMoviesIds.Count}");
        moviesToDisplay = await GetMovieDetailsFromIdList(receivedMoviesIds.GetRange(startPos, amount));
        Console.WriteLine($"GetMoviesOnGivenPage: pageN:{pageN} startPos:{startPos} amount:{amount} moviesToDisplay.Count:{moviesToDisplay.Count}");
    }


    private async Task SearchMoviesByName()
    {
        IEnumerable<int> moviesIds;

        TitleToDisplay = "Search Result: ";
        moviesToDisplay = null;
        searchResultIsEmpty = false;

        if (string.IsNullOrWhiteSpace(searchMovieName))
        {
            return;
        }

        var httpResponse = await Http.GetAsync(searchMoviesByKeywordApiUrl + searchMovieName);

        if ((int)httpResponse.StatusCode != 200)
        {
            Console.WriteLine($"EROARE SearchMoviesByName: {httpResponse.ReasonPhrase}");
            TitleToDisplay = "Sorry, no movies to show 😔";
            searchResultIsEmpty = true;
            return;
        }

        moviesIds = await httpResponse.Content.ReadFromJsonAsync<List<int>>();
        moviesIds = moviesIds.Take(20);     // am limitat numarul de intrari afisare in caz ca vor fi prea multe

        moviesToDisplay = await GetMovieDetailsFromIdList(moviesIds);

        searchMovieName = string.Empty;
    }


    private async Task SearchMoviesByCategory(string category)
    {
        IEnumerable<int> moviesIds;

        TitleToDisplay = category + " movies:";
        moviesToDisplay = null;
        searchResultIsEmpty = false;

        Console.WriteLine(searchMoviesByCategoryApiUrl + category);
        var httpResponse = await Http.GetAsync(searchMoviesByCategoryApiUrl + category);

        if ((int)httpResponse.StatusCode != 200)
        {
            Console.WriteLine($"EROARE SearchMoviesByCategory: {httpResponse.ReasonPhrase}");
            TitleToDisplay = $"Sorry, no {category} movies to show 😔";
            searchResultIsEmpty = true;
            return;
        }

        moviesIds = await httpResponse.Content.ReadFromJsonAsync<List<int>>();
        moviesIds = moviesIds.Take(20);     // am limitat numarul de intrari afisare in caz ca vor fi prea multe

        moviesToDisplay = await GetMovieDetailsFromIdList(moviesIds);

    }

    private async Task<List<MovieDetails>> GetMovieDetailsFromIdList(IEnumerable<int> moviesIds)
    {
        List<MovieDetails> result = new List<MovieDetails>();

        foreach (int id in moviesIds)
        {
            Console.WriteLine(id);
            MovieDetails temp = await GetMovieDetailsById(id);
            if (temp == null)
            {  // pentru filmele al caror id inca nu e in MovieManagementService
                continue;
            }
            Console.WriteLine($"{temp.Title} {temp.PosterUrl}");
            result.Add(temp);
        }

        return result;
    }

    private async Task<MovieDetails> GetMovieDetailsById(int id)
    {
        string apiUrl = "http://localhost:5000/api/Movies/HomeMoviesData/" + id.ToString();
        MovieDetails movie;

        var httpResponse = await Http.GetAsync(apiUrl);

        if ((int)httpResponse.StatusCode != 200)
        {
            Console.WriteLine($"EROARE GetMovieDetailsById: {httpResponse.ReasonPhrase} pentru id-ul {id}");
            return null;
        }

        movie = await httpResponse.Content.ReadFromJsonAsync<MovieDetails>();

        return movie;
    }

    public async Task<bool> IsUserLoggedIn()
    {
        var token = await sessionStorage.GetItemAsync<string>("jwt");
        return !string.IsNullOrWhiteSpace(token);
    }

    public class MovieDetails
    {
        public int Id { get; set; }
        public string Title { get; set; }
        public string Genres { get; set; }
        public string PosterUrl { get; set; }
    }
}
